FUEL-FileUploadExploitationLab
===============================
FUEL is an abbreviation for `File Upload Exploitation Lab` that aims to be a modular, extensible and simple framework to evaluate unrestricted file upload (UFU) vulnerabilities or vulnerability scanners.
It encompasses 15 unique UFU scenarios with bypassable file validation checks.
While the 15 scenarios primarily focus on PHP-based UFU vulnerabilities, FUEL in itself is language-agnostic and we welcome contributions to extend FUEL with scenarios covering other languages.
Detailed information about each scenario can be found within a scenario's README.

FUEL was used to evaluate four state-of-the-art UFU vulnerability scanners. The results of the evaluation can be found in [FUEL-Evaluation](https://github.com/FUEL-Project/FUEL-Evaluation).
The academic paper titled `Bringing UFUs Back into the Air With FUEL: A Framework for Evaluating the Effectiveness of Unrestricted File Upload Vulnerability Scanners` is to be published at [DIMVA 2024](https://www.dimva.org/dimva2024/).

# Requirements

In order to use FUEL, you need the following software installed:

- Docker
- Docker compose extension
- Git

# Usage

Clone the repository to a directory on your system:

```
git clone https://github.com/FUEL-Project/FUEL-FileUploadExploitationLab.git
```

Change into the directory:

```
cd FUEL-FileUploadExploitationLab/FUEL/
```

And then bring up the file upload scenarios with docker compose:

```
sudo docker compose up --build
``` 

Each scenario is mapped to one port on the Docker host:

- Scenario 1 -> Port 10001
- Scenario 2 -> Port 10002
- Scenario 3 -> Port 10003
- Scenario N -> Port 10000 + N

You can find the main menue at any scenario's port in `/menue/`, i.e., 'http://localhost:10001/menue/'. 

To reset FUEL for a new evaluation round, it is enough to stop and restart the containers:

```
sudo docker compose down
sudo docker compose up --build --force-recreate
```

# Scenarios
Currently, FUEL supports the following scenarios:


- **Unrestricted**: 
This scenario poses as a baseline since no validation is performed on the uploaded file, allowing the upload of any file, including `.php` files.

- **Client-side**: 
This scenario only implements client-side validation.
By intercepting and manipulating the HTTP request, an attacker can circumvent the client-side validation to upload a PHP file.

- **MIME-type**: 
Only the uploaded file's MIME-type is validated server-side using the value provided in the `Content-Type` header.
The intended bypass is uploading a malicious file and changing the header to a permissible value, e.g., uploading `exploit.php` with type `image/png`.

- **Extension I**:
Checking for known dangerous file extensions, such as `.php`, is modeled in this scenario.
Alternative extensions which are passed to the PHP interpreter, e.g., `.php5` or `.php8`, bypass this check.

- **Extension II**:
Similar to the previous scenario, another bypass is changing the capitalization of individual file name's letters, e.g., `exploit.pHp`.

- **Extension III**:
Misconfigured web servers might pass any file with `.php` in the file name, such as `exploit.php.png`, to the PHP interpreter, circumventing file extension checks.

- **Extension IV**:
This scenario does not prevent the upload of configuration files, such as `.htaccess`, to change the web server's or PHP interpreter's behavior to execute malicious files.

- **Extension V**:
Stripping prohibited extensions from file names is dangerous if not performed correctly, e.g., recursively.
The intended bypass for this scenario is nesting the file extension, such as `.p.phphp` becoming `.php`.

- **Magic number**:
Determining the file type from the first or last bytes of the file content is insufficient, as the file's content may contain executable code.
For example, `GIF87a<?php phpinfo(); ?>` uploaded as `file.php` might be detected as a `image/gif` file due to the correct file header.

- **File content**:
Similar to the previous scenario, valid image files may contain PHP code in their metadata.
Thus, checking the dimensions of an image file renamed to `file.php` succeeds, but so does the execution by the PHP interpreter when it encounters the PHP code.  

- **Directory configuration**:
This scenario disables the PHP interpreter for the `uploads/` folder.
However, path traversal techniques may allow uploading in another location, such as `/`, where the PHP interpreter is not disabled.

- **Special characters**:
Null bytes or other special characters may not be handled correctly by the application, allowing it to bypass validation checks.
The intended bypass is placing a Null byte in the file name, e.g., `file.php\%00.png`.

- **XSS**:
If file names are displayed to the user without escaping special characters, they may be used for XSS attacks, although the application processes no file content.
This scenario models the upload of, e.g., `<img src=x onerror=alert(1)>.png`, which will trigger a JavaScript alert.

- **Race condition**:
External programs, such as antivirus scanners, might delete or block access to uploaded files if found to be malicious.
Such an analysis usually incurs a delay, which might give attackers enough time to access and execute the file.
The intended exploit is uploading a file and accessing it before the web server returns the HTTP response after deleting it.

- **PUT method**:
Web applications may use JavaScript or other technologies to dynamically perform HTTP requests to a backend server, including changes to the HTTP request method.
This scenario models a situation in which an HTTP PUT request is used to create and update files on the server.


# Contributions

We welcome contributions to FUSE, especially new UFU scenarios.

Please open a pull request on GitHub for us to review and merge. 

## Extending FUEL

To extend FUEL, create a new subfolder `scenarioX` and create a `Dockerfile` defining how the respective Docker container will be build. 
The container should include the vulnerable web application, a web server and all other dependencies for it work.
If possible, the web application should include a link back to `/menue/`, but this is optional.


Then, a free port and IP address should be chosen. If possible, these should be `Port: 10000+X` and `IP: 172.22.1.X`. 
Finally, the `docker-compose.yml` must be extended with the new scenario's container definition and replacing `<Port>` with the new port and `<IP>` with the new IP:

```
scenarioX:
build:
  context: ./scenarioX
  dockerfile: Dockerfile
ports:
  - '<Port>:80'
volumes:
  - ./menue/:/var/www/html/menue/
networks:
  fuel_network:
    ipv4_address: <IP>
```

# Paper & Authors

This file upload exploitation lab was developed for the academic publication by Sebastian Neef and Maath Oudeh.

If you use the the lab, please cite it as follows:

```
TBD
```

You can find a preprint of the paper [here](TBD) and the camera-ready version [here](TBD)
